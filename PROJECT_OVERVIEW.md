# CryptIQ — Project Overview

A full‑stack, containerized web application for simulated crypto trading and portfolio tracking with authentication, live market data, leaderboards, and learning content.

## Quick Start

- Prereqs: Docker and Docker Compose
- Generate env (optional helper):
  - Node helper is provided to scaffold `.env` and copy it:  
    - `node env.js init` (creates `.env` in repo root)  
    - `node env.js copy` (copies `.env` to `frontend/.env` and `backend/.env`)
- Run:
```bash
# docker compose build + start
docker compose up -d --build
# Frontend: http://localhost:5000
# Backend API: http://localhost:3000
```
- Windows caveat: Compose variable interpolation may fail; copy values from `.env` into `compose.yaml` explicitly (e.g., set `MYSQL_CONNECTION_URI` directly).

## High‑Level Features (Non‑Technical)

- Authentication and onboarding
  - Email/password and Google OAuth via SuperTokens
  - Password reset emailed via OneSignal (custom HTML template)
- Dashboard
  - Portfolio summary across 10 supported coins (BTC, ETH, BNB, XRP, ADA, DOGE, SOL, DOT, LTC, UNI)
  - Live crypto price chart with multiple time ranges (Live, 1d, 5d, 1M, 6M, YTD, 1Y)
  - Net worth vs Gold (XAU) vs S&P500 ETF (SPY) benchmarking
  - Leaderboard with top 10 users and personal rank
  - Recent transactions history
- Trading simulation
  - Buy/Sell with a fixed 2% fee, balance checks, and coin quantity validation
- News
  - Top headlines via CoinDesk API
- Learn
  - Curated educational pages on crypto, trading strategies, risk, tax, etc.
- Contact
  - Contact form posting to backend and persisting messages

## System Architecture

- Frontend
  - React (Vite), Tailwind CSS, Shadcn UI primitives
  - Recharts for charts; WebSockets for live streams
  - SuperTokens Web SDK for sessions
- Backend
  - Go + Chi router; SuperTokens server integration (session, email/password, third‑party, user metadata, dashboard)
  - Background schedulers (cron) and workers for periodic updates
  - Integrations:
    - Binance REST + WebSocket Streams (prices, 24hr change)
    - TwelveData (SPY, XAU prices)
    - CoinDesk (news)
    - OneSignal (password reset email)
- Datastores
  - Postgres for application data
  - MySQL for SuperTokens (auth)
- Containers (compose.yaml)
  - cryptiq-frontend: Node 23 + Vite preview, port 8080 -> 5000 on host
  - cryptiq-backend: Go 1.23 alpine, port 3000
  - supertokens: supertokens-mysql, port 3567, depends on MySQL
  - mysql: MySQL (auth), port 3306
  - db: Postgres (app), port 5432
  - Healthchecks on backend, mysql, supertokens, db
  - Networks: `auth_network`, `db_network`

```yaml
# compose excerpt (key ports)
services:
  frontend: ports: ["5000:8080"]
  backend:  ports: ["3000:3000"]
  supertokens: ports: ["3567:3567"]
  mysql: ports: ["3306:3306"]
  db: ports: ["5432:5432"]
```

## Environment Variables

Defined in `.env.example` (and generated by `env.js`). Key groups:

- Auth (MySQL for SuperTokens)
  - AUTH_MYSQL_ROOT_PASSWORD, AUTH_MYSQL_USER, AUTH_MYSQL_PASSWORD, AUTH_MYSQL_DATABASE
- SuperTokens
  - SUPERTOKENS_MYSQL_CONNECTION_URI (mysql://…@mysql:3306/supertokens)
  - SUPERTOKENS_API_KEY
- Backend admin (for SuperTokens dashboard)
  - BACKEND_ADMIN_EMAIL, BACKEND_ADMIN_PASSWORD
- Google OAuth
  - GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET
- App DB (Postgres)
  - POSTGRES_PASSWORD, POSTGRES_DB, POSTGRES_URL (postgres://postgres:…@db:5432/cryptiq)
- OneSignal (email delivery)
  - ONESIGNAL_APP_ID, ONESIGNAL_API_KEY
- CoinDesk
  - COINDESK_API_KEY
- TwelveData
  - TWELVEDATA_API_KEY_SPY, TWELVEDATA_API_KEY_XAU
- App domains
  - BACKEND_URL (default http://localhost:3000)
  - FRONTEND_URL (default http://localhost:5000)

Frontend also uses `frontend/config.js` for:
```js
export const backendURL = "http://localhost:3000";
export const frontendURL = "http://localhost:5000";
export const websocketURL = `ws://localhost:3000`;
```

## Backend Overview (Go)

- Entry: `backend/main.go`
  - Loads env and initializes SuperTokens:
    - Connection to self-hosted `http://supertokens:3567` with API key
    - AppInfo: AppName=CryptIQ, APIDomain=BACKEND_URL, WebsiteDomain=FRONTEND_URL
    - Recipes: dashboard, usermetadata, emailpassword, thirdparty (Google), session
    - Overrides:
      - SignUp: store `name` into usermetadata
      - EmailDelivery: password-reset email via OneSignal with `template/reset.html`
      - ThirdParty SignInUp: extract or fallback a name, write to usermetadata
  - Middleware: CORS (allowed origin = FRONTEND_URL), SuperTokens
  - Startup workers:
    - utils.SetupAdminUser(): creates dashboard admin user in SuperTokens
    - database.Init(): connect Postgres, run migrations, start price update workers
    - twelvedata.Init(): SPY/XAU price fetchers (120s)
    - routes.Init(): price cache updater (5s) for dashboard coins
    - routes.BinanceInit(): long‑lived WS to Binance combined streams (avgPrice)
  - Cron:
    - Twice per hour (minute 0 and 30) execute DB procedure `capture_networth_snapshot()`
  - Server: http.ListenAndServe on 0.0.0.0:3000
  - Health: GET /healthcheck returns “OK”

### API Surface

Auth: many routes require session via `session.VerifySession(nil, handler)`

- Name
  - GET /name — returns current user’s name (requires session)
  - POST /name — update name in user metadata (requires session)
- Balance
  - GET /balance — current user balance (requires session)
- Portfolio
  - GET /portfolio — user coin quantities + current price map (requires session)
  - GET /portfolio/historic — latest 672 snapshots sorted ascending (requires session)
  - GET /portfolio/spy-xau — user SPY/XAU quantities + current prices (requires session)
- Transactions
  - GET /transactions — user transactions (requires session)
  - POST /transactions — create transaction (BUY/SELL) with validation and 2% fee (requires session)
- Leaderboard
  - GET /leaderboard — WebSocket endpoint streaming top 10 users by net worth
  - GET /leaderboard/me — JSON with current user’s rank and net worth (requires session)
- Crypto data
  - GET /crypto/priceChange — 24hr percent change map for 10 coins (Binance)
  - GET /crypto/historic/{coin}/{time} — historic klines; time ∈ {2m,1d,5d,1M,6M,YTD,1Y}
  - GET /crypto/{coin} — WebSocket stream for coin (USDT pair) relaying Binance stream messages
- News
  - GET /news — top 15 CoinDesk articles (requires `COINDESK_API_KEY`)
- Contact
  - POST /contact — persist contact form
- Password
  - POST /new_password — change password (old->new) with policy validation (requires session)
- Health
  - GET /healthcheck — used by Docker healthcheck

### External Integrations

- Binance
  - REST: avg price, klines, 24h ticker for selected coins
  - WS: combined streams for avgPrice of tracked coins
- TwelveData
  - Fetch SPY and XAU prices every 120s
- CoinDesk
  - Fetch top 15 articles with API key auth
- OneSignal
  - Send HTML password reset emails via Notifications API (c=email channel)
- SuperTokens
  - Self‑hosted auth backend (Docker service), MySQL storage

### Data Model (Postgres)

Defined in `backend/database/migrations/0001_init.sql`:

- balances(user_id PK, balance, last_updated) — initialized to 5000 on first access
- transactions(transaction_id PK UUID, user_id, type, symbol, amount, exchange_rate, transaction_charges, total, created_at)
- portfolio(user_id PK, per‑coin qty/price columns for 10 coins + spy/xau; generated columns:
  - networth = sum(qty_i * price_i)
  - xau_networth = xau_qty * xau_price
  - spy_networth = spy_qty * spy_price
- contact(id SERIAL, name, email, message, created_at)
- networth_snapshots(snapshot_id SERIAL, user_id, networth, spy_networth, xau_networth, snapshot_time)
- Procedure:
```sql
CREATE OR REPLACE PROCEDURE capture_networth_snapshot() LANGUAGE plpgsql AS $$
BEGIN
  INSERT INTO networth_snapshots (user_id, networth, spy_networth, xau_networth)
  SELECT user_id, networth, spy_networth, xau_networth FROM portfolio;
END;
$$;
```

### Background Workers

- On DB init:
  - Update coin prices every 20s: writes `*_price` columns in `portfolio` for all supported coins
  - Update SPY/XAU prices every 20s: writes `spy_price`, `xau_price`
- routes.Init(): fetch guest price cache for dashboard every 5s via Binance avgPrice
- twelvedata.Init(): fetch SPY/XAU price every 120s
- cron: call `capture_networth_snapshot()` at minute 0 and 30

### Trading Logic

- Supported coins: `{"BTC","ETH","BNB","XRP","ADA","DOGE","SOL","DOT","LTC","UNI"}`
- Transaction types: `BUY`, `SELL`
- Fee: fixed 2% (`utils.TransactionCharges = 0.02`)
- BUY flow:
  - Validate symbol/type/amount
  - Ensure user balance >= total (amount*price + fee)
  - Insert transaction, decrement balance, update portfolio qty
  - Update SPY/XAU “equivalent units” by converting traded USD value into respective units
- SELL flow:
  - Validate holdings >= amount
  - Insert transaction, increment balance, decrement portfolio qty
  - Update SPY/XAU equivalent units symmetrically

## Frontend Overview (React + Vite)

- App shell
  - Routing: `react-router-dom` with pages: `/`, `/login`, `/signup`, `/reset-password`, `/auth/callback/google`, `/news`, `/about`, `/contact`, `/dashboard`, `/learn/*`
  - Theme: `ThemeProvider` with dark default; toggle via `ThemeToggle`
  - Auth context: `AuthContext` (SuperTokens session: sets `isLoggedIn`, `userID`, and pulls `/name`)
- Dashboard
  - Tabs: Dashboard | Transactions | Leaderboard | User Settings
  - UserStats
    - Live and historic charts per selected coin
    - Uses:
      - GET `/crypto/historic/{COIN}USDT/{period}`
      - WS `/crypto/{COIN}USDT` for Live updates
      - GET `/portfolio`, `/leaderboard/me`, `/portfolio/historic`, `/portfolio/spy-xau`, `/news`, `/crypto/priceChange`, `/balance`
    - Displays Net Worth, Net Worth (Gold), Net Worth (S&P 500), Leaderboard position
  - TransactionsList
    - GET `/transactions`, display table with type, asset, amount, rate, fee, total, relative date
  - Leaderboard
    - WS `/leaderboard` to stream top 10
    - GET `/leaderboard/me` to show current user rank snapshot
  - TradingDialog
    - POST `/transactions` with `{type, symbol, amount}`
    - Validates sell quantity; shows 2% fee breakdown client‑side
- Contact
  - POST `/contact` with `{name,email,message}`; toast feedback
- Auth
  - SuperTokens Web SDK initialization (Session + EmailPassword + ThirdParty)
  - Google OAuth callback route `/auth/callback/google`
- Charts
  - `recharts` AreaChart and LineChart for price and historic net worth
- Styling/UI
  - Tailwind CSS v4
  - Shadcn UI (local components)
- Config
  - `frontend/config.js` centralizes `backendURL`, `frontendURL`, `websocketURL`

## DevOps

- Dockerfiles
  - Backend (Go 1.23 alpine)
    - Build static binary at `/backend`, exposes 3000
  - Frontend (Node 23 alpine)
    - Install, build, `vite preview` on port 8080
- Compose
  - Healthchecks for backend (GET /healthcheck), mysql (mysqladmin ping), supertokens (TCP hello), db (pg_isready)
  - Robust dependencies and networks for isolation
- CI (GitLab)
  - merge_requests guard: only `trunk` can merge into `release`
  - `pages` deploy stage: builds static site via a shared script (COM2027 context)
  - `webhook` job on `trunk` pushes a webhook (monitoring/integration)

## Security Considerations

- Sessions/Auth
  - SuperTokens session middleware protects most API routes
  - CORS restricted to `FRONTEND_URL`; `AllowCredentials: true`
- Sensitive data
  - Secrets required for Google OAuth, CoinDesk, TwelveData, OneSignal
- Email reset
  - Reset emails routed via OneSignal; custom HTML template used
- WebSockets
  - `websocket.Upgrader` `CheckOrigin` returns `true` (accepts any origin). Consider restricting to `FRONTEND_URL` in production.
- Validation
  - Server validates transaction types, symbols, amounts; contact email format validated
- Rate limiting / abuse
  - Not present; consider adding request throttling for transactional endpoints and WS

## Limitations & Known Issues

- Hosted app occasionally hangs due to Cloudflare tunnel connection drops (no current fix upstream)
- No server‑side pagination on transactions
- Fixed 2% transaction fee; no fee configuration
- No foreign key constraints shown between app tables and SuperTokens users (IDs from SuperTokens are used)
- No server‑side input sanitization beyond basic checks; rate limiting absent
- Price update intervals are fixed; no backoff across outages for some workers
- Leaderboard WS not authenticated; origin not restricted by server (relies on network isolation and CORS for HTTP)

## How Data Flows

1) User signs in (Session cookie via SuperTokens)  
2) Frontend retrieves:
   - `/name`, `/balance`, `/portfolio`, `/leaderboard/me`, `/news`
   - `/crypto/priceChange`, `/portfolio/historic`, `/portfolio/spy-xau`  
3) Live chart:
   - Seed with `/crypto/historic/{COIN}USDT/2m` then subscribe WS `/crypto/{COIN}USDT`  
4) Trading:
   - POST `/transactions` → DB write, balances/portfolio updated, SPY/XAU equivalents adjusted  
5) Background:
   - Portfolio prices refreshed periodically from Binance/TwelveData  
   - Cron snapshots net worth into `networth_snapshots`

## API Reference (Selected Examples)

- Get balance
```bash
curl -i --cookie "sAccessToken=..." http://localhost:3000/balance
```
- Create transaction
```bash
curl -i -X POST http://localhost:3000/transactions \
  -H "Content-Type: application/json" \
  --cookie "sAccessToken=..." \
  -d '{"type":"BUY","symbol":"BTC","amount":0.01}'
```
- Live crypto WS (BTC)
```bash
# Connect a WS client to:
ws://localhost:3000/crypto/BTCUSDT
```
- Leaderboard stream
```bash
# WS stream of top10
ws://localhost:3000/leaderboard
```
- Historic prices
```bash
curl http://localhost:3000/crypto/historic/BTCUSDT/1d
```
- News
```bash
curl -H "Authorization: Apikey $COINDESK_API_KEY" http://localhost:3000/news
```

## Testing & Tooling

- Frontend: `npm run test` uses `vitest`; no test files present in repo tree
- Linting: ESLint 9 + React plugins; Prettier + Tailwind plugin
- Build: Vite 6

## Suggested Improvements

- Security
  - Restrict WS `CheckOrigin` to `FRONTEND_URL`
  - Add rate limiting on POST/WS endpoints
  - Consider FK constraints and cascade behavior for app tables
- Reliability
  - Retry/backoff for external API outages; circuit breakers
  - Better error surfaces to frontend (standard error payloads)
- UX
  - In‑app notifications on trade success/failure without full page reload
  - Pagination/filters for transactions
  - Configurable fee and fee breakdown server‑side
- Observability
  - Structured logging and metrics
  - Health endpoints per integration (Binance, TwelveData, CoinDesk)

## File Map (Key)

- Backend
  - `main.go` — server init, routes, cron
  - `routes/*.go` — HTTP/WS endpoints (balance, portfolio, transactions, news, contact, name, supertokens, binance relays)
  - `database/*` — migrations, queries, periodic price updates, snapshots
  - `twelvedata/twelvedata.go` — SPY/XAU price fetchers
  - `binance/avg_price.go` — Binance avg price REST client
  - `utils/*` — fees, HTTP helpers, admin bootstrap, name retrieval
- Frontend
  - `src/pages/*.jsx` — pages (Landing, Login/Signup, Dashboard, News, Contact, Learn)
  - `src/components/*` — UI and feature components (UserStats, Transactions, Leaderboard, TradingDialog)
  - `src/context/*` — `AuthContext`, `ThemeContext`
  - `config.js` — URLs for backend/websocket
- DevOps
  - `compose.yaml` — services: frontend, backend, supertokens, mysql, db
  - `backend/Dockerfile`, `frontend/Dockerfile`
  - `.gitlab-ci.yml` — MR policy, pages, and trunk webhook
  - `.env.example`, `env.js` helpers
